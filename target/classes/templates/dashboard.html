<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: linear-gradient(135deg, #2c3e50, #3498db); color: #e0e0e0; font-family: 'Arial', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border-radius: 15px; padding: 1.5rem; }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container mx-auto mt-8 space-y-6">
    <h1 class="text-4xl font-bold text-white">Dashboard</h1>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="glass">
            <div class="text-gray-300">Total Students</div>
            <div class="text-3xl font-bold" th:text="${totalStudents}">0</div>
        </div>
        <div class="glass">
            <div class="text-gray-300">Total Teachers</div>
            <div class="text-3xl font-bold" th:text="${totalTeachers}">0</div>
        </div>
        <div class="glass">
            <div class="text-gray-300">Total Courses</div>
            <div class="text-3xl font-bold" th:text="${totalCourses}">0</div>
        </div>
        <div class="glass">
            <div class="text-gray-300">Total Timetables</div>
            <div class="text-3xl font-bold" th:text="${totalTimetables}">0</div>
        </div>
    </div>

    <!-- Analytics Charts -->
    <div class="glass">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl">Analytics Overview</h3>
            <div class="space-x-2">
                <a th:href="@{/analytics/export/students}" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">Export Students</a>
                <a th:href="@{/analytics/export/grades}" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">Export Grades</a>
                <a th:href="@{/analytics/export/fees}" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700">Export Fees</a>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h4 class="text-lg mb-2">Students by Course</h4>
                <canvas id="studentsChart" width="300" height="200"></canvas>
            </div>
            <div>
                <h4 class="text-lg mb-2">Grade Distribution</h4>
                <canvas id="gradesChart" width="300" height="200"></canvas>
            </div>
            <div>
                <h4 class="text-lg mb-2">Attendance Trends (7 Days)</h4>
                <canvas id="attendanceChart" width="300" height="200"></canvas>
            </div>
            <div>
                <h4 class="text-lg mb-2">Fee Collection Status</h4>
                <canvas id="feesChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Role-Based Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Staff/Teacher -->
        <div class="glass" sec:authorize="hasAnyRole('STAFF','REGISTRAR','HOD')">
            <h2 class="text-2xl mb-2">Academic Management</h2>
            <ul class="list-disc ml-6">
                <li><a th:href="@{/grades}" class="text-blue-400 hover:underline">Manage grades</a></li>
                <li><a th:href="@{/assignments}" class="text-blue-400 hover:underline">Assignments</a></li>
                <li><a th:href="@{/enrollments}" class="text-blue-400 hover:underline">Manage enrollments</a></li>
                <li><a th:href="@{/attendance/mark}" class="text-blue-400 hover:underline">Mark attendance</a></li>
            </ul>
        </div>

        <!-- Librarian -->
        <div class="glass" sec:authorize="hasRole('LIBRARIAN')">
            <h2 class="text-2xl mb-2">Library Management</h2>
            <ul class="list-disc ml-6">
                <li><a th:href="@{/library/books}" class="text-blue-400 hover:underline">Manage books</a></li>
                <li><a th:href="@{/library/issues}" class="text-blue-400 hover:underline">Book issues</a></li>
                <li><a th:href="@{/library/overdue}" class="text-blue-400 hover:underline">Overdue books</a></li>
            </ul>
        </div>

        <!-- Accountant -->
        <div class="glass" sec:authorize="hasRole('ACCOUNTANT')">
            <h2 class="text-2xl mb-2">Finance Management</h2>
            <ul class="list-disc ml-6">
                <li><a th:href="@{/fees}" class="text-blue-400 hover:underline">Manage fees</a></li>
                <li><a th:href="@{/fees/overdue}" class="text-blue-400 hover:underline">Overdue fees</a></li>
            </ul>
        </div>

        <!-- Counselor -->
        <div class="glass" sec:authorize="hasRole('COUNSELOR')">
            <h2 class="text-2xl mb-2">Student Support</h2>
            <ul class="list-disc ml-6">
                <li><a th:href="@{/messages}" class="text-blue-400 hover:underline">Messages</a></li>
                <li>Counseling sessions (future)</li>
            </ul>
        </div>

        <!-- Admin -->
        <div class="glass" sec:authorize="hasRole('ADMIN')">
            <h2 class="text-2xl mb-2">System Administration</h2>
            <ul class="list-disc ml-6">
                <li><a th:href="@{/files}" class="text-blue-400 hover:underline">File management</a></li>
                <li><a th:href="@{/messages/compose}" class="text-blue-400 hover:underline">Send announcements</a></li>
            </ul>
        </div>

        <!-- Student Portal -->
        <div class="glass" sec:authorize="hasRole('STUDENT')">
            <h2 class="text-2xl mb-2">Student Portal</h2>
            <ul class="list-disc ml-6">
                <li><a th:href="@{/assignments}" class="text-blue-400 hover:underline">My assignments</a></li>
                <li><a th:href="@{/fees/student}" class="text-blue-400 hover:underline">My fees</a></li>
                <li><a th:href="@{/messages}" class="text-blue-400 hover:underline">Messages</a></li>
            </ul>
        </div>
    </div>
</div>

<script>
    // Students by Course Chart
    fetch('/analytics/students-by-course')
        .then(response => response.json())
        .then(data => {
            const ctx1 = document.getElementById('studentsChart').getContext('2d');
            new Chart(ctx1, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#e0e0e0' } }
                    }
                }
            });
        })
        .catch(() => {
            // Fallback chart if no data
            const ctx1 = document.getElementById('studentsChart').getContext('2d');
            new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['No Data'],
                    datasets: [{ data: [1], backgroundColor: ['#6b7280'] }]
                },
                options: { responsive: true, plugins: { legend: { labels: { color: '#e0e0e0' } } } }
            });
        });

    // Grade Distribution Chart
    fetch('/analytics/grade-distribution')
        .then(response => response.json())
        .then(data => {
            const ctx2 = document.getElementById('gradesChart').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#e0e0e0' } } },
                    scales: {
                        x: { ticks: { color: '#e0e0e0' } },
                        y: { ticks: { color: '#e0e0e0' }, beginAtZero: true }
                    }
                }
            });
        })
        .catch(() => {
            const ctx2 = document.getElementById('gradesChart').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: { labels: ['No Data'], datasets: [{ data: [0], backgroundColor: ['#6b7280'] }] },
                options: { responsive: true, plugins: { legend: { labels: { color: '#e0e0e0' } } }, scales: { x: { ticks: { color: '#e0e0e0' } }, y: { ticks: { color: '#e0e0e0' } } } }
            });
        });

    // Attendance Trends Chart
    fetch('/analytics/attendance-trends')
        .then(response => response.json())
        .then(data => {
            const ctx3 = document.getElementById('attendanceChart').getContext('2d');
            new Chart(ctx3, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#e0e0e0' } } },
                    scales: {
                        x: { ticks: { color: '#e0e0e0' } },
                        y: { ticks: { color: '#e0e0e0' }, beginAtZero: true, max: 100 }
                    }
                }
            });
        })
        .catch(() => {
            const ctx3 = document.getElementById('attendanceChart').getContext('2d');
            new Chart(ctx3, {
                type: 'line',
                data: { labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], datasets: [{ label: 'Attendance %', data: [85,90,88,92,87,89,91], borderColor: '#60a5fa', backgroundColor: 'rgba(96, 165, 250, 0.1)', fill: true }] },
                options: { responsive: true, plugins: { legend: { labels: { color: '#e0e0e0' } } }, scales: { x: { ticks: { color: '#e0e0e0' } }, y: { ticks: { color: '#e0e0e0' }, beginAtZero: true, max: 100 } } }
            });
        });

    // Fee Collection Chart
    fetch('/analytics/fee-collection')
        .then(response => response.json())
        .then(data => {
            const ctx4 = document.getElementById('feesChart').getContext('2d');
            new Chart(ctx4, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: '#e0e0e0' } } }
                }
            });
        })
        .catch(() => {
            const ctx4 = document.getElementById('feesChart').getContext('2d');
            new Chart(ctx4, {
                type: 'pie',
                data: { labels: ['Paid','Pending','Overdue'], datasets: [{ data: [60,30,10], backgroundColor: ['#28a745','#ffc107','#dc3545'] }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#e0e0e0' } } } }
            });
        });
</script>
</body>
</html>
